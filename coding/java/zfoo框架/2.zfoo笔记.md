# zfoo笔记

## 目录

- [zfoo笔记](#zfoo笔记)
  - [目录](#目录)
  - [启动配置](#启动配置)
    - [单服启动配置](#单服启动配置)
    - [Spring AppContextEvent](#spring-appcontextevent)
  - [协议生成](#协议生成)
  - [测试](#测试)
    - [协议模拟](#协议模拟)

## 启动配置

zfoo 版本: `zfoo-java-11-17`

Tank 版本: `3.2.0`

### 单服启动配置

- `admin` 启动端口
  - `application.yml`
  - `application-dev.yml`
- `single-boot` 配置
  - `application.yml`
  - `application-dev.yml`
  - `application-pro.yml`
- `single` 依赖 `common` 中的配置
  - `deploy-zfoo.properties` zfoo.net环境
  - `deploy-dev.properties` 开发环境
  - `deploy-pro.properties` 正式环境

### Spring AppContextEvent

应用启动事件，这个使用spring自带的事件机制，自研的event事件仅用在业务逻辑

启动顺序为：`AppStartBeforeEvent -> AppStartEvent -> AppStartAfterEvent` 都继承于 `ApplicationEvent`

- `com.zfoo.event.model.AppStartEvent`
- `com.zfoo.event.model.AppStartBeforeEvent`
- `com.zfoo.event.model.AppStartAfterEvent`
- 业务代码:

  ```java
  //触发事件
  context.publishEvent(new AppStartEvent(context));
  ```

## 协议生成

- `com.zfoo.protocol.generate.GenerateProtocolFile#generate` 生成各种语言的协议文件
- 使用方式:

  ```java
  // 解析protocol.xml文件，并将协议生成ProtocolRegistration
  ProtocolManager.initProtocol(xmlProtocols, generateOperation);
  //如果第二个参数使用 GenerateOperation.NO_OPERATION 则不创建任何协议文件
  ```

- 对应配置 如:`deploy-dev.properties`

  ```properties
  # 生成的文件协议 参考类CodeLanguage
  net.code.languages=Python,Csharp
  # 是否生成目录
  net.fold.protocol=true
  # 协议生成路径
  net.protocol.path=${project.build.directory}/protocol
  ```

- `NetDefinitionParser` 解析配置生成: `NetConfig`
  - `protocol-path`->`protocolPath`
  - `application.xml`
  
    ```xml
      <net:config id="tankCache" protocol-location="protocol.xml"
                code-languages="${net.code.languages}"
                fold-protocol="${net.fold.protocol}"
                protocol-path="${net.protocol.path}">
      </net:config>
    ```

## 测试

### 协议模拟

`com.zfoo.tank.single.client.MyTankClientTest`